<!DOCTYPE html>
<head>
  <title>Snake Web Client</title>
</head>

<body>
  <h2>Snake</h2>

  <canvas id="snakeCanvas"></canvas>

  <button id="start">Start</button>
  <button id="stop">Stop</button>
</body>

<style>
body {
  text-align: center;
}

h2 {
  text-align: center;
}

canvas {
  display: block;
  margin: auto;
  margin-bottom: 1rem;
  border: solid 1px #ddd;
}

button {
  margin: auto;
  padding: 0.5rem 1rem;
}
</style>

<script>
  const height = 400;
  const width = 400;

  const c = document.getElementById("snakeCanvas");
  const ctx = c.getContext("2d");
  c.width = width;
  c.height = height;

  const clear = () => {
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, c.width, c.height);
  }

  const renderSnake = (xScale, yScale, snake) => {
    for (part of snake.parts) {
      ctx.fillStyle = "black";
      ctx.fillRect(part.x * xScale, part.y * yScale, xScale, yScale);
    }
  }

  const renderFruit = (xScale, yScale, fruits) => {
    for (fruit of fruits) {
      ctx.fillStyle = "green";
      ctx.fillRect(fruit.x * xScale, fruit.y * yScale, xScale, yScale);
    }
  }

  const renderState = (state) => {
    const xScale = Math.floor(width / state.width);
    const yScale = Math.floor(height / state.height);

    clear()
    renderSnake(xScale, yScale, state.snake);
    renderFruit(xScale, yScale, state.fruit);
  }

  //-----------
  // Websocket
  //-----------
  const ws = new WebSocket("ws://" + window.location.host +"/ws");

  document.getElementById("start").addEventListener("click", () => {
    ws.send(JSON.stringify({ type: "new", width: 40, height: 40, tick: 10 }));
  })

  document.getElementById("stop").addEventListener("click", () => {
    ws.send(JSON.stringify({ type: "destroy" }));
  })

  document.body.addEventListener("keydown", (e) => {
    switch (e.keyCode) {
      case 38:
        ws.send(JSON.stringify({ type: "input", direction: "up" }));
      case 37:
        ws.send(JSON.stringify({ type: "input", direction: "left" }));
      case 40:
        ws.send(JSON.stringify({ type: "input", direction: "down" }));
      case 39:
        ws.send(JSON.stringify({ type: "input", direction: "right" }));
    }
  })

  ws.onmessage = (e) => {
    const payload = JSON.parse(e.data);
    if (payload.type === "state") {
      renderState(payload.data)
    }
  }
</script>
